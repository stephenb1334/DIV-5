<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Legal RAG System - Advanced AI Legal Research</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
        }

        .system-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info-color);
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-modes {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid var(--secondary-color);
            background: white;
            color: var(--secondary-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .mode-btn.active {
            background: var(--secondary-color);
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        .search-input-group {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .ai-response {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .source-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .source-local { background: #e8f5e8; color: #27ae60; }
        .source-atlas { background: #e3f2fd; color: #1976d2; }
        .source-memory { background: #fff3e0; color: #f57c00; }
        .source-perplexity { background: #fce4ec; color: #c2185b; }

        .misinformation-alert {
            background: #ffebee;
            border: 2px solid var(--danger-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: var(--danger-color);
        }

        .fact-check-result {
            background: #f1f8e9;
            border: 2px solid var(--success-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .confidence-meter {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
            transition: width 0.5s ease;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .confidence-recommendation-card {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid var(--warning-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .confidence-progress {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-current {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
            transition: width 0.5s ease;
        }

        .confidence-target {
            height: 100%;
            background: var(--success-color);
            opacity: 0.3;
            position: absolute;
            top: 0;
            transition: width 0.5s ease;
        }

        .recommendation-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .recommendation-item:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .recommendation-action {
            font-weight: 500;
            color: var(--primary-color);
        }

        .recommendation-cost {
            font-size: 0.85em;
            color: var(--info-color);
        }

        .apply-btn {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .apply-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .apply-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .formatted-result-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }

        .formatted-result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-badges {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-score {
            background: var(--info-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .result-preview {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .expandable-content {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 3px solid var(--secondary-color);
        }

        @media (max-width: 768px) {
            .search-modes {
                justify-content: center;
            }
            
            .mode-btn {
                font-size: 0.8em;
                padding: 6px 12px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }

            .confidence-progress {
                flex-direction: column;
                gap: 10px;
            }

            .recommendation-item {
                padding: 10px;
            }

            .result-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header Section -->
            <div class="header-section">
                <h1><i class="fas fa-gavel"></i> Enhanced Legal RAG System</h1>
                <p class="mb-0">Advanced AI-Powered Legal Research with Fact-Checking & Pro Se Protection</p>
            </div>

            <!-- System Status -->
            <div class="system-status">
                <h5><i class="fas fa-server"></i> System Status</h5>
                <div id="system-status-content">
                    {% if system_status.system_initialized %}
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Local Documents:</strong> {{ system_status.local_documents }}
                            </div>
                            <div class="col-md-3">
                                <strong>Knowledge Entities:</strong> {{ system_status.memory_entities }}
                            </div>
                            <div class="col-md-3">
                                <strong>Status:</strong> <span class="text-success">✅ Ready</span>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="perplexity-toggle" checked onchange="togglePerplexityAPI()">
                                    <label class="form-check-label" for="perplexity-toggle">
                                        <small><i class="fas fa-globe"></i> Perplexity API</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> System not initialized
                            {% if system_status.error %}
                                <br><small>{{ system_status.error }}</small>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Feature Overview -->
            <div class="feature-grid">
                <div class="feature-card" onclick="switchTab('search')" style="cursor: pointer;">
                    <div class="feature-icon"><i class="fas fa-search"></i></div>
                    <h6>Hybrid Search</h6>
                    <small>Search across local documents and real-time web data</small>
                </div>
                <div class="feature-card" onclick="switchTab('fact-check')" style="cursor: pointer;">
                    <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                    <h6>Fact-Checking</h6>
                    <small>Real-time verification of legal claims with misinformation detection</small>
                </div>
                <div class="feature-card" onclick="showKnowledgeGraph()" style="cursor: pointer;">
                    <div class="feature-icon"><i class="fas fa-brain"></i></div>
                    <h6>Knowledge Graph</h6>
                    <small>Legal knowledge storage and relationship mapping</small>
                </div>
                <div class="feature-card" onclick="switchTab('strategy')" style="cursor: pointer;">
                    <div class="feature-icon"><i class="fas fa-map-marker-alt"></i></div>
                    <h6>Delaware County Intel</h6>
                    <small>Jurisdiction-specific strategic legal intelligence</small>
                </div>
            </div>

            <!-- Main Interface Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('search')">
                    <i class="fas fa-search"></i> Search
                </div>
                <div class="tab" onclick="switchTab('fact-check')">
                    <i class="fas fa-shield-alt"></i> Fact Check
                </div>
                <div class="tab" onclick="switchTab('strategy')">
                    <i class="fas fa-chess"></i> Strategy
                </div>
                <div class="tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i> History
                </div>
            </div>

            <!-- Search Tab -->
            <div id="search-tab" class="tab-content active">
                <div class="search-section">
                    <h4><i class="fas fa-search"></i> Legal Research Query</h4>
                    
                    <!-- Search Modes -->
                    <div class="search-modes">
                        <div class="mode-btn active" data-mode="comprehensive">
                            <i class="fas fa-globe"></i> Comprehensive
                        </div>
                        <div class="mode-btn" data-mode="local">
                            <i class="fas fa-folder"></i> Local Documents
                        </div>
                        <div class="mode-btn" data-mode="perplexity">
                            <i class="fas fa-globe"></i> Web Research
                        </div>
                        <div class="mode-btn" data-mode="memory">
                            <i class="fas fa-brain"></i> Knowledge Graph
                        </div>
                    </div>

                    <!-- Search Input -->
                    <div class="search-input-group">
                        <input type="text" id="search-input" class="search-input" 
                               placeholder="Enter your legal research question..." 
                               onkeypress="handleKeyPress(event)">
                    </div>

                    <!-- Search Options -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable-fact-check" checked>
                                <label class="form-check-label" for="enable-fact-check">
                                    Enable Fact-Checking
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="max-results" class="form-label">Max Results:</label>
                            <select id="max-results" class="form-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <div class="text-center">
                        <button id="search-btn" class="search-btn" onclick="performSearch()">
                            <i class="fas fa-search"></i> Search Legal Database
                        </button>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Processing your legal research query...</p>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="results-section" style="display: none;">
                    <!-- AI Response will be inserted here -->
                </div>
            </div>

            <!-- Fact Check Tab -->
            <div id="fact-check-tab" class="tab-content">
                <div class="search-section">
                    <h4><i class="fas fa-shield-alt"></i> Legal Fact Checker</h4>
                    <p class="text-muted">Verify legal claims and detect misinformation</p>
                    
                    <div class="search-input-group">
                        <input type="text" id="fact-check-input" class="search-input" 
                               placeholder="Enter a legal claim to fact-check..." 
                               onkeypress="handleFactCheckKeyPress(event)">
                    </div>
                    
                    <div class="text-center">
                        <button id="fact-check-btn" class="search-btn" onclick="performFactCheck()">
                            <i class="fas fa-shield-alt"></i> Verify Claim
                        </button>
                    </div>
                </div>
                
                <div id="fact-check-results" class="results-section" style="display: none;">
                    <!-- Fact check results will be inserted here -->
                </div>
            </div>

            <!-- Strategy Tab -->
            <div id="strategy-tab" class="tab-content">
                <div class="search-section">
                    <h4><i class="fas fa-chess"></i> Delaware County Strategy</h4>
                    <p class="text-muted">Get jurisdiction-specific strategic legal advice</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="case-type" class="form-label">Case Type:</label>
                            <select id="case-type" class="form-select">
                                <option value="divorce" selected>Divorce</option>
                                <option value="custody">Child Custody</option>
                                <option value="support">Support</option>
                                <option value="property">Property Division</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="search-input-group">
                        <input type="text" id="strategy-input" class="search-input" 
                               placeholder="Enter your strategic question..." 
                               onkeypress="handleStrategyKeyPress(event)">
                    </div>
                    
                    <div class="text-center">
                        <button id="strategy-btn" class="search-btn" onclick="getStrategy()">
                            <i class="fas fa-chess"></i> Get Strategic Advice
                        </button>
                    </div>
                </div>
                
                <div id="strategy-results" class="results-section" style="display: none;">
                    <!-- Strategy results will be inserted here -->
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="search-section">
                    <h4><i class="fas fa-history"></i> Search History</h4>
                    <p class="text-muted">Your recent legal research queries</p>
                    
                    <div id="search-history-content">
                        <!-- Search history will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Knowledge Graph Modal -->
            <div class="modal fade" id="knowledgeGraphModal" tabindex="-1" aria-labelledby="knowledgeGraphModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="knowledgeGraphModalLabel">
                                <i class="fas fa-brain"></i> Legal Knowledge Graph
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="knowledge-graph-content">
                                <!-- Knowledge graph visualization will be loaded here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="refreshKnowledgeGraph()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSearchMode = 'comprehensive';
        let perplexityEnabled = true;

        // Initialize Perplexity toggle state from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedState = localStorage.getItem('perplexityEnabled');
            if (savedState !== null) {
                perplexityEnabled = JSON.parse(savedState);
                document.getElementById('perplexity-toggle').checked = perplexityEnabled;
            }
            updatePerplexityUI();
        });

        // Toggle Perplexity API
        function togglePerplexityAPI() {
            perplexityEnabled = document.getElementById('perplexity-toggle').checked;
            localStorage.setItem('perplexityEnabled', JSON.stringify(perplexityEnabled));
            updatePerplexityUI();
        }

        // Update UI based on Perplexity state
        function updatePerplexityUI() {
            const webResearchBtn = document.querySelector('[data-mode="perplexity"]');
            const factCheckOption = document.getElementById('enable-fact-check');
            
            if (perplexityEnabled) {
                webResearchBtn.style.opacity = '1';
                webResearchBtn.style.pointerEvents = 'auto';
                webResearchBtn.title = '';
                factCheckOption.disabled = false;
            } else {
                webResearchBtn.style.opacity = '0.5';
                webResearchBtn.style.pointerEvents = 'none';
                webResearchBtn.title = 'Perplexity API is disabled';
                factCheckOption.disabled = true;
                factCheckOption.checked = false;
                
                // Switch away from perplexity mode if currently selected
                if (currentSearchMode === 'perplexity') {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-mode="comprehensive"]').classList.add('active');
                    currentSearchMode = 'comprehensive';
                }
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Load specific tab data
            if (tabName === 'history') {
                loadSearchHistory();
            }
        }

        // Search mode selection
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentSearchMode = this.dataset.mode;
            });
        });

        // Key press handlers
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        function handleFactCheckKeyPress(event) {
            if (event.key === 'Enter') {
                performFactCheck();
            }
        }

        function handleStrategyKeyPress(event) {
            if (event.key === 'Enter') {
                getStrategy();
            }
        }

        // Main search function
        async function performSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const searchBtn = document.getElementById('search-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultsSection = document.getElementById('results-section');

            // Show loading state
            searchBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            resultsSection.style.display = 'none';

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        search_mode: currentSearchMode,
                        enable_fact_check: document.getElementById('enable-fact-check').checked,
                        max_results: parseInt(document.getElementById('max-results').value),
                        perplexity_enabled: perplexityEnabled
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displaySearchResults(data);
                } else {
                    displayError('Search failed: ' + data.error);
                }
            } catch (error) {
                displayError('Network error: ' + error.message);
            } finally {
                searchBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Display search results
        function displaySearchResults(data) {
            const resultsSection = document.getElementById('results-section');
            
            let html = '';

            // AI Response with Enhanced Confidence Display
            if (data.ai_response) {
                const confidencePercent = (data.confidence_score * 100).toFixed(1);
                const confidenceColor = data.confidence_score >= 0.95 ? 'var(--success-color)' :
                                      data.confidence_score >= 0.75 ? 'var(--warning-color)' : 'var(--danger-color)';
                
                html += `
                    <div class="ai-response">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-robot"></i> AI Analysis</h5>
                            <div class="text-end">
                                <div class="confidence-meter" style="width: 200px;">
                                    <div class="confidence-fill" style="width: ${confidencePercent}%; background-color: ${confidenceColor};"></div>
                                </div>
                                <small style="color: ${confidenceColor};">Confidence: ${confidencePercent}%</small>
                            </div>
                        </div>
                        <p class="mt-3">${data.ai_response}</p>
                    </div>
                `;
            }

            // Confidence Recommendations
            if (data.confidence_recommendation) {
                const rec = data.confidence_recommendation;
                const currentPercent = (rec.current_confidence * 100).toFixed(1);
                const targetPercent = (rec.target_confidence * 100).toFixed(1);
                
                html += `
                    <div class="confidence-recommendation-card">
                        <h6><i class="fas fa-chart-line text-warning"></i> Confidence Enhancement Recommendations</h6>
                        
                        <div class="confidence-progress">
                            <div style="min-width: 80px;">
                                <small><strong>Current:</strong> ${currentPercent}%</small>
                            </div>
                            <div class="confidence-bar" style="position: relative;">
                                <div class="confidence-current" style="width: ${currentPercent}%;"></div>
                                <div class="confidence-target" style="width: ${targetPercent}%;"></div>
                            </div>
                            <div style="min-width: 80px; text-align: right;">
                                <small><strong>Target:</strong> ${targetPercent}%</small>
                            </div>
                        </div>
                        
                        ${rec.recommendations && rec.recommendations.length > 0 ? `
                            <div class="mb-3">
                                <strong><i class="fas fa-lightbulb text-warning me-2"></i>Recommended Actions:</strong>
                                <div class="mt-3">
                                    ${rec.recommendations.map((recommendation, index) => `
                                        <div class="recommendation-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="recommendation-action">${recommendation.action}</div>
                                                    ${recommendation.estimated_cost ? `
                                                        <div class="recommendation-cost">Estimated cost: $${recommendation.estimated_cost.toFixed(3)}</div>
                                                    ` : ''}
                                                </div>
                                                <button class="apply-btn" onclick="applyRecommendation(${index}, '${recommendation.action.replace(/'/g, "\\'")}')">
                                                    <i class="fas fa-play me-1"></i>Apply
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${rec.explanation ? `
                            <div class="mt-3 p-3 bg-white bg-opacity-50 rounded">
                                <small><i class="fas fa-info-circle text-info me-2"></i><strong>Why these recommendations:</strong> ${rec.explanation}</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Misinformation Alerts
            if (data.misinformation_alerts && data.misinformation_alerts.length > 0) {
                data.misinformation_alerts.forEach(alert => {
                    html += `
                        <div class="misinformation-alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Misinformation Alert:</strong> ${alert}
                        </div>
                    `;
                });
            }

            // Strategic Advice
            if (data.strategic_advice) {
                html += `
                    <div class="result-card">
                        <h6><i class="fas fa-chess"></i> Delaware County Strategic Advice</h6>
                        <p>${data.strategic_advice}</p>
                    </div>
                `;
            }

            // Search Results - Use formatted results if available
            if (data.formatted_results && data.formatted_results.length > 0) {
                html += '<h5><i class="fas fa-list"></i> Search Results</h5>';
                
                data.formatted_results.forEach((result, index) => {
                    html += `
                        <div class="formatted-result-card">
                            <div class="result-header">
                                <div class="result-badges">
                                    ${result.icon ? `<i class="${result.icon} me-2 text-primary"></i>` : ''}
                                    <span class="source-badge source-${result.source_type}">${result.source_display}</span>
                                    ${result.category ? `<span class="badge bg-secondary ms-2">${result.category}</span>` : ''}
                                </div>
                                <span class="result-score">${result.relevance_score}%</span>
                            </div>
                            
                            ${result.title ? `<h6 class="mb-3 text-primary">${result.title}</h6>` : ''}
                            
                            ${result.misinformation_alert ? `
                                <div class="misinformation-alert mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Misinformation Alert:</strong> ${result.misinformation_alert}
                                </div>
                            ` : ''}
                            
                            ${result.verification_status ? `
                                <div class="fact-check-result mb-3">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    <strong>Fact Check:</strong> ${result.verification_status}
                                </div>
                            ` : ''}
                            
                            <div class="result-preview">
                                ${result.preview}
                            </div>
                            
                            ${result.expandable_content ? `
                                <details class="mt-3">
                                    <summary class="text-primary fw-bold" style="cursor: pointer;">
                                        <i class="fas fa-chevron-down me-2"></i>View Full Content
                                    </summary>
                                    <div class="expandable-content">
                                        ${result.expandable_content}
                                    </div>
                                </details>
                            ` : ''}
                            
                            ${result.metadata && Object.keys(result.metadata).length > 0 ? `
                                <details class="mt-3">
                                    <summary class="text-muted fw-bold" style="cursor: pointer;">
                                        <i class="fas fa-info-circle me-2"></i>Document Details
                                    </summary>
                                    <div class="mt-2 p-3 bg-light rounded">
                                        ${Object.entries(result.metadata).map(([key, value]) =>
                                            `<div class="mb-1"><small><strong>${key}:</strong> ${value}</small></div>`
                                        ).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                });
            } else if (data.search_results && data.search_results.length > 0) {
                // Fallback to raw results if formatted results not available
                html += '<h5><i class="fas fa-list"></i> Search Results</h5>';
                
                data.search_results.forEach((result, index) => {
                    const sourceClass = `source-${result.source}`;
                    html += `
                        <div class="result-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="source-badge ${sourceClass}">${result.source.toUpperCase()}</span>
                                    <span class="badge bg-secondary">${result.category}</span>
                                </div>
                                <small class="text-muted">Score: ${(result.relevance_score * 100).toFixed(1)}%</small>
                            </div>
                            
                            ${result.misinformation_alert ? `
                                <div class="misinformation-alert">
                                    ${result.misinformation_alert}
                                </div>
                            ` : ''}
                            
                            ${result.verification_status ? `
                                <div class="fact-check-result">
                                    <strong>Fact Check:</strong> ${result.verification_status}
                                </div>
                            ` : ''}
                            
                            <p>${result.content}</p>
                            
                            ${result.metadata && Object.keys(result.metadata).length > 0 ? `
                                <details>
                                    <summary>Metadata</summary>
                                    <pre class="mt-2">${JSON.stringify(result.metadata, null, 2)}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                });
            }

            // Cost Information
            if (data.cost_breakdown) {
                const perplexityStatus = data.cost_breakdown.perplexity_enabled ?
                    '<span class="text-success">✅ Enabled</span>' :
                    '<span class="text-warning">⚠️ Disabled</span>';
                
                html += `
                    <div class="result-card">
                        <h6><i class="fas fa-dollar-sign"></i> Cost Breakdown</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small>Perplexity API: ${perplexityStatus}</small>
                            </div>
                            <div class="col-md-6">
                                <small>
                                    Queries: ${data.cost_breakdown.perplexity_queries || 0}
                                    (Est. Cost: $${(data.cost_breakdown.estimated_cost || 0).toFixed(3)})
                                </small>
                            </div>
                        </div>
                        ${!data.cost_breakdown.perplexity_enabled ?
                            '<small class="text-muted">Note: Fact-checking and web research features are disabled when Perplexity API is off.</small>' :
                            ''}
                    </div>
                `;
            }

            resultsSection.innerHTML = html;
            resultsSection.style.display = 'block';
        }

        // Fact checking function
        async function performFactCheck() {
            const claim = document.getElementById('fact-check-input').value.trim();
            if (!claim) {
                alert('Please enter a claim to fact-check');
                return;
            }

            const factCheckBtn = document.getElementById('fact-check-btn');
            const resultsDiv = document.getElementById('fact-check-results');

            factCheckBtn.disabled = true;
            factCheckBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

            try {
                const response = await fetch('/api/fact-check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        claim: claim,
                        perplexity_enabled: perplexityEnabled
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `
                        <div class="result-card">
                            <h5><i class="fas fa-shield-alt"></i> Fact Check Result</h5>
                            <p><strong>Claim:</strong> ${data.claim}</p>
                            <div class="fact-check-result">
                                <strong>Result:</strong> ${data.result.fact_check_result || 'Unknown'}
                            </div>
                            ${data.result.detailed_analysis ? `
                                <p><strong>Analysis:</strong> ${data.result.detailed_analysis}</p>
                            ` : ''}
                            ${data.cached ? '<small class="text-muted">Result from cache</small>' : ''}
                        </div>
                    `;
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                } else {
                    displayError('Fact check failed: ' + data.error);
                }
            } catch (error) {
                displayError('Network error: ' + error.message);
            } finally {
                factCheckBtn.disabled = false;
                factCheckBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Verify Claim';
            }
        }

        // Strategy function
        async function getStrategy() {
            const query = document.getElementById('strategy-input').value.trim();
            const caseType = document.getElementById('case-type').value;
            
            if (!query) {
                alert('Please enter a strategic question');
                return;
            }

            const strategyBtn = document.getElementById('strategy-btn');
            const resultsDiv = document.getElementById('strategy-results');

            strategyBtn.disabled = true;
            strategyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';

            try {
                const response = await fetch('/api/delaware-strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        case_type: caseType,
                        perplexity_enabled: perplexityEnabled
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `
                        <div class="result-card">
                            <h5><i class="fas fa-chess"></i> Delaware County Strategic Analysis</h5>
                            <p><strong>Case Type:</strong> ${data.case_type}</p>
                            <p><strong>Query:</strong> ${data.query}</p>
                            <div class="fact-check-result">
                                ${data.strategy.strategic_intelligence || 'No specific strategic advice available'}
                            </div>
                        </div>
                    `;
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                } else {
                    displayError('Strategy analysis failed: ' + data.error);
                }
            } catch (error) {
                displayError('Network error: ' + error.message);
            } finally {
                strategyBtn.disabled = false;
                strategyBtn.innerHTML = '<i class="fas fa-chess"></i> Get Strategic Advice';
            }
        }

        // Load search history
        async function loadSearchHistory() {
            try {
                const response = await fetch('/api/search-history');
                const data = await response.json();

                if (data.success) {
                    const historyDiv = document.getElementById('search-history-content');
                    
                    if (data.history.length === 0) {
                        historyDiv.innerHTML = '<p class="text-muted">No search history available</p>';
                        return;
                    }

                    let html = '';
                    data.history.forEach((item, index) => {
                        html += `
                            <div class="result-card">
                                <div class="d-flex justify-content-between">
                                    <strong>${item.query}</strong>
                                    <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                                </div>
                                <div class="mt-2">
                                    <small>Confidence: ${(item.confidence * 100).toFixed(1)}% | Sources: ${item.sources.join(', ')}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    historyDiv.innerHTML = html;
                } else {
                    document.getElementById('search-history-content').innerHTML =
                        '<p class="text-danger">Failed to load search history</p>';
                }
            } catch (error) {
                document.getElementById('search-history-content').innerHTML =
                    '<p class="text-danger">Error loading search history</p>';
            }
        }

        // Error display function
        function displayError(message) {
            const resultsSection = document.getElementById('results-section');
            resultsSection.innerHTML = `
                <div class="result-card">
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error:</strong> ${message}
                    </div>
                </div>
            `;
            resultsSection.style.display = 'block';
        }

        // Auto-refresh system status
        setInterval(async () => {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();
                
                if (data.success) {
                    const statusContent = document.getElementById('system-status-content');
                    statusContent.innerHTML = `
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Local Documents:</strong> ${data.local_documents}
                            </div>
                            <div class="col-md-3">
                                <strong>Knowledge Entities:</strong> ${data.memory_entities}
                            </div>
                            <div class="col-md-3">
                                <strong>Status:</strong> <span class="text-success">✅ Ready</span>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="perplexity-toggle" ${perplexityEnabled ? 'checked' : ''} onchange="togglePerplexityAPI()">
                                    <label class="form-check-label" for="perplexity-toggle">
                                        <small><i class="fas fa-globe"></i> Perplexity API</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.log('Status update failed:', error);
            }
        }, 30000); // Update every 30 seconds

        // Knowledge Graph Functions
        async function showKnowledgeGraph() {
            const modal = new bootstrap.Modal(document.getElementById('knowledgeGraphModal'));
            modal.show();
            await loadKnowledgeGraph();
        }

        async function loadKnowledgeGraph() {
            const contentDiv = document.getElementById('knowledge-graph-content');
            contentDiv.innerHTML = '<div class="text-center"><div class="spinner"></div><p>Loading knowledge graph...</p></div>';

            try {
                const response = await fetch('/api/knowledge-graph');
                const data = await response.json();

                if (data.success) {
                    displayKnowledgeGraph(data.graph);
                } else {
                    contentDiv.innerHTML = `<div class="text-danger">Failed to load knowledge graph: ${data.error}</div>`;
                }
            } catch (error) {
                contentDiv.innerHTML = `<div class="text-danger">Error loading knowledge graph: ${error.message}</div>`;
            }
        }

        function displayKnowledgeGraph(graph) {
            const contentDiv = document.getElementById('knowledge-graph-content');
            
            let html = '<div class="row">';
            
            // Entities Section
            html += '<div class="col-md-6">';
            html += '<h6><i class="fas fa-users"></i> Legal Entities</h6>';
            
            if (graph.entities && graph.entities.length > 0) {
                graph.entities.forEach(entity => {
                    html += `
                        <div class="result-card mb-2">
                            <h6>${entity.name}</h6>
                            <small class="text-muted">Type: ${entity.entityType}</small>
                            ${entity.observations && entity.observations.length > 0 ? `
                                <div class="mt-2">
                                    <strong>Observations:</strong>
                                    <ul class="mt-1">
                                        ${entity.observations.map(obs => `<li>${obs}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html += '<p class="text-muted">No entities found</p>';
            }
            
            html += '</div>';
            
            // Relations Section
            html += '<div class="col-md-6">';
            html += '<h6><i class="fas fa-project-diagram"></i> Relationships</h6>';
            
            if (graph.relations && graph.relations.length > 0) {
                graph.relations.forEach(relation => {
                    html += `
                        <div class="result-card mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">${relation.from}</span>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <span class="badge bg-secondary me-2">${relation.relationType}</span>
                                <i class="fas fa-arrow-right mx-2"></i>
                                <span class="badge bg-success">${relation.to}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p class="text-muted">No relationships found</p>';
            }
            
            html += '</div>';
            html += '</div>';
            
            // Summary Statistics
            html += `
                <div class="mt-3 p-3 bg-light rounded">
                    <h6><i class="fas fa-chart-bar"></i> Graph Statistics</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Total Entities:</strong> ${graph.entities ? graph.entities.length : 0}
                        </div>
                        <div class="col-md-6">
                            <strong>Total Relations:</strong> ${graph.relations ? graph.relations.length : 0}
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }

        async function refreshKnowledgeGraph() {
            await loadKnowledgeGraph();
        }

        // Apply confidence recommendation
        async function applyRecommendation(index, action) {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                alert('Please enter a search query first');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';

            try {
                let newParams = {};
                
                // Parse the recommendation action and apply appropriate changes
                if (action.includes('Expand to 20 results')) {
                    document.getElementById('max-results').value = '20';
                    newParams.max_results = 20;
                } else if (action.includes('Enable Perplexity')) {
                    if (!perplexityEnabled) {
                        document.getElementById('perplexity-toggle').checked = true;
                        togglePerplexityAPI();
                    }
                    newParams.perplexity_enabled = true;
                } else if (action.includes('Search all sources')) {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-mode="comprehensive"]').classList.add('active');
                    currentSearchMode = 'comprehensive';
                    newParams.search_mode = 'comprehensive';
                } else if (action.includes('Enable fact-checking')) {
                    document.getElementById('enable-fact-check').checked = true;
                    newParams.enable_fact_check = true;
                }

                // Re-run the search with enhanced parameters
                await performSearch();
                
                // Show success message
                button.innerHTML = '<i class="fas fa-check text-success"></i> Applied';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error applying recommendation:', error);
                button.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        // Enhanced search with confidence tracking
        async function performEnhancedSearch(additionalParams = {}) {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const searchBtn = document.getElementById('search-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultsSection = document.getElementById('results-section');

            // Show loading state
            searchBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            resultsSection.style.display = 'none';

            try {
                const searchParams = {
                    query: query,
                    search_mode: currentSearchMode,
                    enable_fact_check: document.getElementById('enable-fact-check').checked,
                    max_results: parseInt(document.getElementById('max-results').value),
                    perplexity_enabled: perplexityEnabled,
                    ...additionalParams
                };

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchParams)
                });

                const data = await response.json();

                if (data.success) {
                    displaySearchResults(data);
                } else {
                    displayError('Search failed: ' + data.error);
                }
            } catch (error) {
                displayError('Network error: ' + error.message);
            } finally {
                searchBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>