<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal RAG Assistant - Pro Se Divorce Case Research</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-gavel"></i>
                    <h1>Legal RAG Assistant</h1>
                </div>
                <div class="subtitle">
                    <p>AI-Powered Legal Research for Pro Se Divorce Case</p>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="query-section">
                <div class="query-container">
                    <h2><i class="fas fa-search"></i> Ask Your Legal Question</h2>
                    <form id="queryForm" class="query-form">
                        <div class="input-group">
                            <textarea 
                                id="queryInput" 
                                placeholder="Enter your legal question here... (e.g., 'What evidence supports financial abandonment?' or 'What legal theories apply to my case?')"
                                rows="3"
                                required
                            ></textarea>
                            <button type="submit" id="submitBtn" class="submit-btn">
                                <i class="fas fa-paper-plane"></i>
                                Search Documents
                            </button>
                        </div>
                    </form>
                    
                    <div class="sample-queries">
                        <h3>Sample Questions:</h3>
                        <div class="sample-buttons">
                            <button class="sample-btn" onclick="fillQuery('What are the legal theories in my case?')">
                                Legal Theories
                            </button>
                            <button class="sample-btn" onclick="fillQuery('What evidence supports financial abandonment?')">
                                Financial Abandonment
                            </button>
                            <button class="sample-btn" onclick="fillQuery('Show me financial contribution information')">
                                Financial Contributions
                            </button>
                            <button class="sample-btn" onclick="fillQuery('Find documents about marital property division')">
                                Property Division
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Searching legal documents and generating AI analysis...</p>
            </div>

            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="ai-response">
                    <h2><i class="fas fa-robot"></i> AI Legal Analysis</h2>
                    <div id="aiResponse" class="response-content"></div>
                </div>

                <div class="retrieved-documents">
                    <h2><i class="fas fa-file-alt"></i> Retrieved Documents</h2>
                    <div id="documentsList" class="documents-list"></div>
                </div>
            </div>

            <div id="errorSection" class="error-section" style="display: none;">
                <div class="error-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error</h3>
                    <p id="errorMessage"></p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Legal RAG Assistant. Powered by Nomic Atlas & OpenRouter AI.</p>
            <p><strong>Disclaimer:</strong> This AI assistant provides informational analysis only. Always consult with a qualified attorney for legal advice.</p>
        </footer>
    </div>

    <script>
        function fillQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        function formatResponse(text) {
            // Convert markdown-style formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        function displayDocuments(documents) {
            const container = document.getElementById('documentsList');
            container.innerHTML = '';

            documents.forEach((doc, index) => {
                const docElement = document.createElement('div');
                docElement.className = 'document-card';
                docElement.innerHTML = `
                    <div class="document-header">
                        <span class="document-number">Document ${index + 1}</span>
                        <span class="similarity-score">Similarity: ${(doc.similarity_score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="document-metadata">
                        <div class="metadata-item">
                            <strong>Category:</strong> ${doc.category}
                        </div>
                        <div class="metadata-item">
                            <strong>Date:</strong> ${doc.date_period}
                        </div>
                        <div class="metadata-item">
                            <strong>Source:</strong> ${doc.source_document}
                        </div>
                        <div class="metadata-item">
                            <strong>Legal Theory:</strong> ${doc.legal_theory_supported}
                        </div>
                    </div>
                    <div class="document-content">
                        <p>${doc.text}</p>
                    </div>
                `;
                container.appendChild(docElement);
            });
        }

        document.getElementById('queryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;

            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (response.ok) {
                    // Display AI response
                    document.getElementById('aiResponse').innerHTML = `<p>${formatResponse(data.ai_response)}</p>`;
                    
                    // Display retrieved documents
                    displayDocuments(data.retrieved_documents);
                    
                    // Show results
                    document.getElementById('resultsSection').style.display = 'block';
                } else {
                    throw new Error(data.error || 'An error occurred');
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorSection').style.display = 'block';
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>